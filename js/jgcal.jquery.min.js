/*
 * jGCal - A Google Calendar Feed Parser and Formatter 
 * @author Kyle Smith <knksmith57@gmail.com>
 * @version 1.2
 */

!function(a,b){a.fn.jgcal=function(r,l,m){var f=a.extend(true,{limit:5,sortAsc:true,tweenTime:1000,startDate:new Date(),refresh:{auto:false,interval:10,timeUnit:"minutes"},params:{alt:"jsonc",v:2,ctz:"America/Detroit",},},r),h,g,o=[],p={},i=[],q=0,e=0,c=["January","February","March","April","May","June","July","August","September","October","November","December"],k=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],j={getFeeds:function(){for(var u in p){var s=this,v;v=a.ajax({url:u,data:p[u].params,dataType:"json"});v.success(function(y){var w=this.url.split("?"+this.data)[0];if(y.data.items&&y.data.items.length>0){for(var x=0;x<y.data.items.length;x++){o.push(s.formatEvent(y.data.items[x].title,y.data.items[x].when,y.data.items[x].location,y.data.items[x].details,y.data.items[x].id,w))}}});v.complete(function(x,w){e++;if(w!=="success"){i.push("Could not retrieve events for "+this.url)}if(e==q){o.sort(s.sortEvents);s.showFeeds();if(a.isFunction(m)){m.call(h,o)}}})}},formatFeeds:function(s){switch(d.typeOfIt(s)){case"undefined":return[];break;case"string":q++;return[{url:s}];break;case"array":var w=[];for(u in s){var v=this.formatFeeds(s[u]);if(v.length>0){for(var u=0;u<v.length;u++){w.push(v[u])}}}return w;break;case"object":q++;return s.url?[s]:[];break;default:return[]}},showErrors:function(){h.append(n.errTemp(i));h.slideDown(f.tweenTime)},showFeeds:function(){var s=this;h.empty();if(o.length>0){for(var u=0;u<o.length&&u<f.limit;u++){h.append(n.feedTemp(o[u],d))}h.slideDown(f.tweenTime)}else{i.push("No events were found");s.showErrors()}},formatEvent:function(D,x,E,u,y,v){var A={ID:y,title:D,date:{start:new Date(x[0].start),end:new Date(x[0].end)},location:E,details:u,group:p[v].group},G=A.date.start,z=A.date.end,F=d.isAllDayEvent(G,z),w=["title","date","month","day","dateString","time","location","details","group"],B={eventID:A.ID,dateObj:A.date,ade:F,mde:(G.getDate()==z.getDate()?false:!F)};for(var C=0;C<w.length;C++){B[w[C]]=n[w[C]](A,G,z,F,d)}return B},sortEvents:function(u,s){if(f.sortAsc){return(u.date.start<s.date.start)?-1:(u.date.start>s.date.start)?1:0}else{return(u.date.start>s.date.start)?-1:(u.date.start<s.date.start)?1:0}}},n=a.extend(true,{feedTemp:function(u){var s='<li class="'+u.group+'">\n<span class="feed-title">'+u.title+'</span><br />\n<span class="feed-date">'+u.dateString+"</span><br />\n";if(u.time!==false){s+='<span class="feed-time">'+u.time+"</span>\n"}if(u.location!==false){s+='<span class="feed-location">'+u.location+"</span>\n"}if(u.details!==false){s+='<div class="feed-details"><pre>'+u.details+"</pre></span>\n"}s+="</li>\n";return s},loadTemp:function(){return'<li class="loading">Loading...</li>\n'},errTemp:function(s){return'<li>Calendar could not be loaded. Please try again\n<div style="display:none">'+s.join(", ")+"</div>\n</li>\n"},title:function(v,u,x,w){return v.title},date:function(v,u,x,w){return(w?x.getDate():u.getDate())},month:function(v,u,x,w){return d.getMonth(u.getMonth())},day:function(v,u,x,w){return(w?d.getDay(x.getDay()):d.getDay(u.getDay()))},dateString:function(w,v,y,x){var u="";if(v.getMonth()==y.getMonth()||x){u+=d.getMonth(y.getMonth());if(!x){u+=" "+v.getDate()}else{u+=" "+y.getDate()}if((v.getDate()!==y.getDate())&&!x){u+="-"+y.getDate()}}else{u+=d.getMonth(v.getMonth())+" "+v.getDate();u+=" - ";u+=d.getMonth(y.getMonth())+" "+y.getDate()}return u},time:function(x,w,z,y){if(y){return false}var v="",A={pm:"PM",am:"AM"},B={hrs:w.getHours(),mins:w.getMinutes(),suf:A.am},u={hrs:z.getHours(),mins:z.getMinutes(),suf:A.am};(function(s){for(t in s){if(s[t].mins<10){s[t].mins="0"+s[t].mins}if(s[t].hrs>12){s[t].hrs-=12;s[t].suf=A.pm}else{if(s[t].hrs==12){s[t].suf=A.pm}else{if(s[t].hrs==0){s[t].hrs=12}}}}})([B,u]);v+=B.hrs;if(B.mins!="00"){v+=":"+B.mins}if((w.getDate()==z.getDate())){if(B.suf!=u.suf){v+=B.suf}v+=" - "+u.hrs;if(u.mins!="00"){v+=":"+u.mins}v+=u.suf}else{if(B.suf==u.suf){v+=B.suf}}return v},location:function(v,u,x,w){if(d.isEmpty(v.location)){return false}else{return v.location}},details:function(v,u,x,w){if(d.isEmpty(v.details)){return false}return v.details},group:function(v,u,x,w){return v.group}},l);var d={typeOfIt:function(s){return typeof(s)=="object"?s.length?"array":"object":typeof(s)},isEmpty:function(s){return/^\s*$/.test(s)},getDay:function(u,s){var v=k[u];return(s?v.slice(0,3):v)},getMonth:function(u,s){var v=c[u];return(s?v.slice(0,3):v)},isAllDayEvent:function(u,s){return((s-u==86400000)&&(u.getHours()==s.getHours())&&(u.getHours()==0||(u.getHours()+(Math.floor(u.getTimezoneOffset()/60))==24)))},rfc3339:function(s){var u=function(w,x){var y="";while(y.length<x-1&&w<Math.pow(10,x-y.length-1)){y+="0"}return y+w.toString()};s=s?s:new Date();var v=s.getTimezoneOffset();return u(s.getFullYear(),4)+"-"+u(s.getMonth()+1,2)+"-"+u(s.getDate(),2)+"T"+u(s.getHours(),2)+":"+u(s.getMinutes(),2)+":"+u(s.getSeconds(),2)+(v>0?"-":"+")+u(Math.floor(Math.abs(v)/60),2)+":"+u(Math.abs(v)%60,2)}};if(f.startDate){f.params["start-min"]=d.rfc3339(f.startDate)}if(f.endDate){f.params["start-max"]=d.rfc3339(f.endDate)}if(f.refresh.auto){(function(){if(typeof(f.refresh.timeUnit)=="string"){var u=/(seconds?|secs?)/gi,s=/(hours?|hrs?)/gi;if(u.test(f.refresh.timeUnit)){f.refresh.timeUnit="seconds";f.refresh.interval*=1000;return}else{if(s.test(f.refresh.timeUnit)){f.refresh.timeUnit="hours";f.refresh.interval*=3600000;return}}}f.refresh.timeUnit="minutes";f.refresh.interval*=60000})()}return this.each(function(){h=a(this).hide();f.feeds=j.formatFeeds(f.feeds);if(!f.feeds||!(f.feeds.length>0)){i.push("Invalid feed was set by user");j.showErrors()}else{for(var u=0;u<f.feeds.length;u++){var s=f.feeds[u].url;p[s]={};if(f.feeds[u].group){p[s].group=f.feeds[u].group}if(f.feeds[u].inherit!==false){p[s].params=a.extend({},f.params)}else{p[s].params={}}if(f.feeds[u].params){p[s].params=a.extend(true,p[s].params,f.feeds[u].params)}if(f.feeds[u].startDate){p[s].params["start-min"]=d.rfc3339(f.feeds[u].startDate)}if(f.feeds[u].endDate){p[s].params["start-max"]=d.rfc3339(f.feeds[u].endDate)}}(function v(){if(f.refresh.auto){setTimeout(v,f.refresh.interval)}o=[];i=[];e=0;j.getFeeds()})()}})}}(jQuery);
